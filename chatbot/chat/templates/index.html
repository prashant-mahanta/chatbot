<!DOCTYPE html>
{% load static %}
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>ChatBot</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">

    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'>

      <link rel="stylesheet" href="{% static 'chat/css/style.css' %}">
</head>
 
<body>
  <div class="card">
    <div class="container ">
    <div class="chat">
      <div class="chat-header clearfix">
        <img src="{% static 'chat/img/chat.png' %}" height="40" width="40" alt="avatar" />
        <div class="chat-about">
          <div class="chat-with">ChatBot</div>
          <!-- <div class="chat-num-messages">chat count</div> -->
        </div>
        <i class="fa fa-star"></i>
      </div> <!-- end chat-header -->
      
      <div class="chat-history">
        <ul>
          
        </ul>
      </div> 
      <!-- end chat-history -->
      
      <div class="chat-message clearfix" id="message-ch">
        <textarea name="message-to-send" id="message-to-send" placeholder ="Type your message" rows="2"></textarea>
                
        <!-- <i class="fa fa-file-o"></i>&nbsp;&nbsp;&nbsp; -->
        <input type="file" id="file-upload" name="file-ch" style="display: none;" />
        <i class="fa fa-file-o" onclick="check()"></i> &nbsp;&nbsp;&nbsp;
        <span id="file-name"></span> 
        <button>Send</button>

      </div> <!-- end chat-message -->
      
    </div> <!-- end chat -->

    <!-- <div class="people-list" id="people-list">
      <ul class="list">
        <li class="clearfix">
          
          <button class="button button2" onclick="ch()">All Files</button>
         
        </li>
      </ul>

    </div> -->
    
  </div> 
  <!-- end container -->
  </div>
<!-- end card -->
{% verbatim %}
<script id="message-template" type="text/x-handlebars-template">
  <li class="clearfix">
    <div class="message-data align-right">
      <span class="message-data-time" >{{time}}</span> &nbsp; &nbsp;
      <span class="message-data-name" >Prashant</span> <i class="fa fa-circle me"></i>
    </div>
    <div class="message other-message float-right">       
         {{messageOutput}}

    </div>
  </li>
</script>
{% endverbatim %}

{% verbatim %}
<script id="message-template-history" type="text/x-handlebars-template">
  <li class="clearfix">
    <div class="message-data align-right">
      <span class="message-data-time" >{{time}}</span> &nbsp; &nbsp;
      <span class="message-data-name" >Prashant</span> <i class="fa fa-circle me"></i>
    </div>
    <div class="message other-message float-right">
         {{messageOutput}}
    </div>
  </li>
</script>
{% endverbatim %}

{% verbatim %}
<script id="modal-template" type="text/x-handlebars-template">
<div id="modal" class="modal">
  <div class="modal-body">
    <h2>{{ title }}</h2>
    <p>{{ cobootstrapntent }}</p>
  </div>
</div>
</script>
{% endverbatim %}

{% verbatim %}
<script id="message-template-history-file" type="text/x-handlebars-template">
  <li class="clearfix">
    <div class="message-data align-right">
      <span class="message-data-time" >{{time}}</span> &nbsp; &nbsp;
      <span class="message-data-name" >Prashant</span> <i class="fa fa-circle me"></i>
    </div>
    <div class="message other-message float-right">
        <!-- {{file}} -->
        <!-- <a href="#" data-behaviour="modal" data-title="1 title of modal" data-content="1 content goes here">View File</a> -->
        <embed src="{{file}}" height=100 width=100 />
    </div>
  </li>
</script>
{% endverbatim %}

{% verbatim %}
<script id="message-response-template" type="text/x-handlebars-template">
  <li>
    <div class="message-data">
      <span class="message-data-name"><i class="fa fa-circle online"></i> Bot</span>
      <span class="message-data-time"> {{time}} </span>
    </div>
    <div class="message my-message">
      {{response}}
    </div>
    <div name="feedback-bot" id="feedback-bot">
         &nbsp;&nbsp;&nbsp;&nbsp;Do you like the response: &nbsp;&nbsp;
          <i  onclick="feedBackPos()" class="fa fa-thumbs-up" id="feedback-bot-up" style="font-size: 2em;" ></i>&nbsp;&nbsp;
          <i onclick="feedBackNeg()" class="fa fa-thumbs-down" id="feedback-bot-down" style="font-size: 2em;" ></i>
    <div>
  </li>
</script>
{% endverbatim %}


{% verbatim %}
<script id="message-response-template-history" type="text/x-handlebars-template">
  <li>
    <div class="message-data">
      <span class="message-data-name"><i class="fa fa-circle online"></i> Bot</span>
      <span class="message-data-time"> {{time}} </span>
    </div>
    <div class="message my-message">
      {{response}}
    </div>
  </li>
</script>
{% endverbatim %}

{% verbatim %}
<script id="message-like" type="text/x-handlebars-template">
  <li>
    <div class="message-data">
      <span class="message-data-name"><i class="fa fa-circle online"></i> Bot</span>
      <span class="message-data-time"> {{time}} </span>
    </div>
    <div class="message my-message">
      <i class="fa fa-thumbs-up" style="font-size: 2em;" ></i>&nbsp;&nbsp;
    </div>
  </li>
</script>
{% endverbatim %}

{% verbatim %}
<script id="message-dislike" type="text/x-handlebars-template">
  <li>
    <div class="message-data">
      <span class="message-data-name"><i class="fa fa-circle online"></i> Bot</span>
      <span class="message-data-time"> {{time}} </span>
    </div>
    <div class="message my-message">
      <i class="fa fa-thumbs-down"  style="font-size: 2em;" ></i>
    </div>
  </li>
</script>
{% endverbatim %}

  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js'></script>

<script type="text/javascript">

  function feedBackPos() {
      $.ajax({
        type: "PUT",
        url : "api-message/",
        dataType: "json",
        data: {"bot-feedback": 1},
        success : function (value) {
              var response = "Thanks! we are working hard to be best.";
              document.getElementById("file-name").innerHTML = response;
              function allert(){
                document.getElementById("file-name").innerHTML = "";
              }
              
              window.setTimeout( allert ,3000 );
              // document.getElementById("file-name").innerHTML = "";
              console.log();
              // console.log("send request response");
              // scrollToBottom();
              // var template = Handlebars.compile( $("#message-dislike").html());
              // var context = { 
              //   time: getCurrentTime()
              // };
              // // console.log(context);
              // this.$chatHistoryList.append(template(context));
              // scrollToBottom();

              // // response
              // var templateResponse = Handlebars.compile( $("#message-response-template").html());
              // var contextResponse = { 
              //     response: "Sorry! We are getting better everyday.",
              //     time: getCurrentTime(),
              //     id: pid
              // };
              // setTimeout(function() {
              //   $chatHistoryList.append(templateResponse(contextResponse));
              //   scrollToBottom();
              // }.bind(this), 2000);
        }
    });

  };

  function feedBackNeg(){
    // window.alert("We are trying to be better everyday");
    // document.getElementById(eid).style.color = 'red'

    $.ajax({
        type: "PUT",
        url : "api-message/",
        dataType: "json",
        data: {"bot-feedback": -1},
        success : function (value) {
              var response = "Sorry! We are getting better everyday.";
              document.getElementById("file-name").innerHTML = response;
              function allert(){
                document.getElementById("file-name").innerHTML = "";
              }
              
              window.setTimeout( allert ,3000 );
              // console.log("send request response");
              // scrollToBottom();
              // var template = Handlebars.compile( $("#message-dislike").html());
              // var context = { 
              //   time: getCurrentTime()
              // };
              // // console.log(context);
              // $chatHistoryList.append(template(context));
              // scrollToBottom();

              // // response
              // var templateResponse = Handlebars.compile( $("#message-response-template").html());
              // var contextResponse = { 
              //     response: "Sorry! We are getting better everyday.",
              //     time: getCurrentTime(),
              //     id: pid
              // };
              // setTimeout(function() {
              //   $chatHistoryList.append(templateResponse(contextResponse));
              //   scrollToBottom();
              // }.bind(this), 2000);
        }
    });
  };

  FileToSend = new File([""], "filename"); 
  var pid = 1;

  function check(){
   var elem = document.getElementById("file-upload");
   FileToSend = elem.files;
   console.log(FileToSend);
   elem.click();
   // console.log(FileToSend.name);
   document.getElementById("file-name").innerHTML =  FileToSend[0].name;
  };
  codekey = 0;

  (function(){

  var chat = {

    messageToSend: '',
    messageResponses: [
      'Why did the web developer leave the restaurant? Because of the table layout.',
      'How do you comfort a JavaScript bug? You console it.',
      'What is the most used language in programming? Profanity.',
      'What is the object-oriented way to become wealthy? Inheritance.',
      'An SEO expert walks into a bar, bars, pub, tavern, public house, Irish pub, drinks, beer, alcohol'
    ],
    init: function() {
      this.cacheDOM();
      this.bindEvents();
      this.render();
      this.earlierMessage();
    },
    cacheDOM: function() {
      this.$chatHistory = $('.chat-history');
      this.$button = $('button');
      this.$textarea = $('#message-to-send');
      this.$chatHistoryList =  this.$chatHistory.find('ul');
    },
    bindEvents: function() {
      this.$button.on('click', this.addMessage.bind(this));
      this.$textarea.on('keyup', this.addMessageEnter.bind(this));
    },
    render: function() {
      this.scrollToBottom();
      pid++;

      // both file and Text 
      if(this.messageToSend.trim() !== '' && FileToSend.length != 0 && FileToSend.length !== undefined){

        var template = Handlebars.compile( $("#message-template").html());
        var context = { 
          messageOutput: this.messageToSend,
          file: "File",
          time: this.getCurrentTime()
        };
        // console.log(context);
        this.$chatHistoryList.append(template(context));
        this.scrollToBottom();
        this.$textarea.val('');
        
        // responses
        var templateResponse = Handlebars.compile( $("#message-response-template").html());
        var contextResponse = { 
          response: this.getRandomItem(this.messageResponses),
          time: this.getCurrentTime(),
          id: pid.toString()
        };

        var formData = new FormData();
        for (var i=0;i<FileToSend.length; i++){
          console.log(FileToSend[i]);
          formData.append("file-q", FileToSend[i]);
        }
        formData.append("text", context.messageOutput);
        
        $.ajax({
          type: "POST",
          url : "api-message/",
          // dataType : "json",
          data: formData,
          cache: false,
          contentType: false,
          processData: false,
          success : function (value) {
            console.log("send request file");
            document.getElementById("file-name").innerHTML =  "";
            $.ajax({
              type: "POST",
              url: "api-message/",
              dataType: "json",
              data: {"text": contextResponse.response, "user": "1"},
              success : function (value) {
                console.log("send request response");
              }
            });
          }
        });

        setTimeout(function() {
          this.$chatHistoryList.append(templateResponse(contextResponse));
          this.scrollToBottom();
        }.bind(this), 2000);
      }
      // Only text Sending
      else if (this.messageToSend.trim() !== '') {
        console.log("Message sending");
        var template = Handlebars.compile( $("#message-template").html());
        var context = { 
          messageOutput: this.messageToSend,
          time: this.getCurrentTime()
        };
        
        this.$chatHistoryList.append(template(context));
        this.scrollToBottom();
        this.$textarea.val('');
        
        // responses
        var templateResponse = Handlebars.compile( $("#message-response-template").html());
        var contextResponse = { 
          response: this.getRandomItem(this.messageResponses),
          time: this.getCurrentTime(),
          id: pid
        };

        $.ajax({
          type: "POST",
          url : "api-message/",
          dataType : "json",
          data: {"text" : this.messageToSend.trim() },
          success : function (value) {
            console.log("send request");
            $.ajax({
              type: "POST",
              url: "api-message/",
              dataType: "json",
              data: {"text": contextResponse.response, "user": "1"},
              success : function (value) {
                console.log("send request");
              }
            });
          }
        });
   
        setTimeout(function() {
          this.$chatHistoryList.append(templateResponse(contextResponse));
          this.scrollToBottom();
        }.bind(this), 3000);
      }
      // Only File is uploaded
      else if(FileToSend.length != 0 && FileToSend.length !== undefined){
        
        console.log(FileToSend.length);
        var template = Handlebars.compile( $("#message-template").html());
        var context = { 
          messageOutput: "File",
          time: this.getCurrentTime()
        };
        // console.log(context);
        this.$chatHistoryList.append(template(context));
        this.scrollToBottom();
        this.$textarea.val('');
        
        // responses
        var templateResponse = Handlebars.compile( $("#message-response-template").html());
        var contextResponse = { 
          response: this.getRandomItem(this.messageResponses),
          time: this.getCurrentTime(),
          id: pid.toString()
        };

        var formData = new FormData();
        for (var i=0;i<FileToSend.length; i++){
          console.log(FileToSend[i]);
          formData.append("file-q", FileToSend[i]);
        }

        
        $.ajax({
          type: "POST",
          url : "api-message/",
          // dataType : "json",
          data: formData,
          cache: false,
          contentType: false,
          processData: false,
          success : function (value) {
            console.log("send request file");
            document.getElementById("file-name").innerHTML =  "";
            $.ajax({
              type: "POST",
              url: "api-message/",
              dataType: "json",
              data: {"text": contextResponse.response, "user": "1"},
              success : function (value) {
                console.log("send request response");
              }
            });
          }
        });

        setTimeout(function() {
          this.$chatHistoryList.append(templateResponse(contextResponse));
          this.scrollToBottom();
        }.bind(this), 3000);
      }
      
    },

    earlierMessage: function() {
      this.scrollToBottom();
      {% if messages %}

        {% for message in messages %}

          {% if message.user == 0 %}

            {% if message.text == None %}
              var template = Handlebars.compile( $("#message-template-history-file").html());
              context = {
                  file: "{{message.file.url|safe}}",
                  time: "{{message.created_at|safe}}"
              }
              this.$chatHistoryList.append(template(context));

            {% else %}
              var template = Handlebars.compile( $("#message-template-history").html());
              var context = { 
                messageOutput: "{{message.text|safe}}",
                file: "{{message.file|safe}}",
                time: "{{message.created_at|safe}}"
              };
              this.$chatHistoryList.append(template(context));
            {% endif %}
            
            this.scrollToBottom();
          {% else %}

            var templateResponse = Handlebars.compile( $("#message-response-template-history").html());
            var contextResponse = { 
              response: "{{message.text|safe}}",
              file: "{{message.file|safe}}",
              time: "{{message.created_at|safe}}"
            };
            this.$chatHistoryList.append(templateResponse(contextResponse));
            this.scrollToBottom();

          {% endif %}

        {% endfor %}

      {% endif %}
    },
    


    addMessage: function() {
      this.messageToSend = this.$textarea.val();
      this.render();         
    },
    addMessageEnter: function(event) {
        // enter was pressed
        if (event.keyCode === 13) {
          console.log("Enter");
          this.addMessage();
        }
    },

    scrollToBottom: function() {
       this.$chatHistory.scrollTop(this.$chatHistory[0].scrollHeight);
    },
    getCurrentTime: function() {
      return new Date().toLocaleTimeString().
              replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/, "$1$3");
    },
    getRandomItem: function(arr) {
      return arr[Math.floor(Math.random()*arr.length)];
    }

    };
  
  chat.init();


})();


</script>


<script type="text/javascript">
  (function() {
  
  // Simple modal 
  var modal = {
    init: function() {

      // Setup the template
      this.source = $("#modal-template").html();
      
      // Setup outercontainer
      this.outercontainer = $('body');

      // Get the stuff
      this.clickToOpenModal();

      // Close the stuff
      this.closeModal();

    },
    clickToOpenModal: function(context, thisLink) {

      $('a[data-behaviour="modal"]').on('click', function(e) {
        var thisLink = $(this);

        var context = {
          title: thisLink.data('title'), 
          content: thisLink.data('content')
        };

        e.preventDefault();
        
         // Do nothing if open
         if ( modal.outercontainer.children('div#modal').length ) return;

         // Attach the content to the the modal
        modal.attachTemplate(context, thisLink);

        // Trigger the open event
        thisLink.trigger('open');
      });

    },
    attachTemplate: function(context, thisLink) {
       var source = Handlebars.compile(this.source);

        this.outercontainer
          .append(source(context))
          .promise()
          .done(function() {

          this
            .children('div#modal')
            .addClass('modal-visible');

           // Close the stuff
           thisLink.one('open', function() {
             modal.closeModal();
           });

       });
    },
    closeModal: function() {
      var container = $("div#modal");

      // Remove modal on click background
      container.on('click', function() {
        container.remove();

      });
      // Remove modal on keypress ESC
      $(document).on( 'keydown', function (e) {
          if ( e.keyCode === 27 ) {
             container.remove();
          }
      });
      // You can click on modal body
      container.find('div.modal-body').on('click', function(e) {
        e.stopPropagation();
      });
    }
  };

  modal.init();

})();
</script>
</body>

</html>

